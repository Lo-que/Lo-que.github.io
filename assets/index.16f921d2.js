import{o as c,c as u,a as l,t as P,n as A,r as d,b as g,T as D,F as T,d as L,e as v,f as x,w as M,v as b,m as O,g as H,h as V,i as k,j as R,k as B,l as F,u as N,p as z,V as q}from"./vendor.7a2ceaf1.js";const K=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))o(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const r of i.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&o(r)}).observe(document,{childList:!0,subtree:!0});function s(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerpolicy&&(i.referrerPolicy=n.referrerpolicy),n.crossorigin==="use-credentials"?i.credentials="include":n.crossorigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function o(n){if(n.ep)return;n.ep=!0;const i=s(n);fetch(n.href,i)}};K();var y=(e,t)=>{const s=e.__vccOpts||e;for(const[o,n]of t)s[o]=n;return s};const G={props:{openTip:String,flap:Boolean}},J={class:"envelope"},X={class:"card"},Y=l("span",{class:"fa fa-close close-icon"},null,-1),Q={class:"text"},W=l("div",{class:"heart"},null,-1);function Z(e,t,s,o,n,i){return c(),u("div",{class:A([{flap:s.flap},"animate__animated animate__zoomIn"]),onClick:t[0]||(t[0]=r=>e.$emit("open"))},[l("div",J,[l("div",X,[Y,l("div",Q,P(s.openTip||"opening...."),1)]),W])],2)}var E=y(G,[["render",Z]]);const ee={props:{src:String}},te={class:"vlog-cover"},ne={class:"vlog-cover-action"},se=["src"];function oe(e,t,s,o,n,i){const r=d("var-icon");return c(),u("div",te,[l("div",ne,[g(r,{name:"play-circle-outline",onClick:t[0]||(t[0]=p=>e.$emit("open")),style:{"font-size":"55px",color:"aliceblue"}})]),l("img",{src:`${s.src}.jpg`,class:"vlog-cover-img"},null,8,se)])}var ie=y(ee,[["render",oe]]);const re={props:{title:String,paragraphs:Array,speed:Number},data(){return{contents:[],finish:!1}},methods:{append(e,t){return new Promise(s=>{const o=new D(e,{strings:["",t],typeSpeed:this.speed,backSpeed:this.speed,showCursor:!1,onComplete:()=>{o.stop(),setTimeout(()=>s(),500)}})})},initContent(){let e=Promise.resolve();e=e.then(()=>this.append(this.$refs["letter-title"],this.title,120)),this.paragraphs.forEach((t,s)=>{e=e.then(()=>new Promise(o=>{const n=/<img[^>]+>/.test(t),i=/<video[^>]+>/.test(t);if(n){const r={type:"img",loading:!0,content:t,ref:`paragraph-img-${s}`};this.contents.push(r),setTimeout(()=>{r.loading=!1,this.$nextTick(()=>{r.dom=this.$refs[r.ref][0],o(),this.autoScroll()})},1200)}else if(i){const r={type:"vlog",loading:!0,content:t,ref:`paragraph-vlog-${s}`};this.contents.push(r),setTimeout(()=>{r.loading=!1,this.$nextTick(()=>{r.dom=this.$refs[r.ref][0],o(),document.querySelector("#vlogPlayer").play(),this.autoScroll()})},1200)}else{const r={type:"text",content:t,ref:`paragraph-text-${s}`};this.contents.push(r),this.$nextTick(()=>{r.dom=this.$refs[r.ref][0],this.append(r.dom,t).then(()=>{this.autoScroll(),o()})})}}))}),e.then(()=>this.finish=!0)},autoScroll(){this.$nextTick(()=>{this.computeDistance().then(e=>{const t=250,s=Date.now();console.log("auto scroll",e);const o=document.body.scrollTop+document.documentElement.scrollTop;requestAnimationFrame(function n(){const i=Math.min(1,(Date.now()-s)/t);document.body.scrollTop=o+e*i,document.documentElement.scrollTop=o+e*i,i<1&&requestAnimationFrame(n)})})})},computeDistance(){return new Promise(e=>{const t=this.contents.length-1;if(t===this.paragraphs.length-1){e(0);return}const s=this.contents[t];if(s.type==="img"){const o=s.dom.children[0];this.onImageLoad(o).then(()=>{setTimeout(()=>{e(s.dom.offsetHeight)},100)})}else e(s.dom.offsetHeight)})},onImageLoad(e){const t=$(e);return new Promise(s=>{t.one("load",s).each((o,n)=>{n.complete&&$(n).trigger("load")})})}},mounted(){this.initContent()}},le={class:"letter-content animate__animated animate__fadeInUp"},ce={class:"letter-title",ref:"letter-title"},ae={class:"letter-detail"},ue={key:1},pe=["innerHTML"],de={key:2,style:{"text-align":"center"}},he=["innerHTML"],ge=l("text",null,"\u56DE\u5230\u804A\u5929\u9875",-1),me={class:"letter-action"};function _e(e,t,s,o,n,i){const r=d("var-loading"),p=d("var-icon"),h=d("var-back-top");return c(),u("div",le,[l("div",ce,null,512),l("div",ae,[(c(!0),u(T,null,L(n.contents,({type:m,content:_,loading:a,ref:f},C)=>(c(),u("div",{key:C,ref_for:!0,ref:`letter-detail-item-${C}`},[a?(c(),v(r,{key:0,color:"#f44336",type:"cube"})):x("",!0),M(l("div",null,[m==="text"?(c(),u("p",{key:0,ref_for:!0,ref:f},null,512)):m==="vlog"?(c(),u("div",ue,[l("div",{style:{width:"320px",height:"256px"},ref_for:!0,ref:f,innerHTML:_},null,8,pe)])):(c(),u("div",de,[l("span",{ref_for:!0,ref:f,innerHTML:_},null,8,he)]))],512),[[b,!a]])]))),128)),M(l("div",{class:"finish-action",onClick:t[0]||(t[0]=m=>e.$emit("close"))},[g(p,{name:"chevron-left"}),ge],512),[[b,n.finish]])]),l("div",me,[g(p,{name:"window-close",style:{"font-size":"25px"},onClick:t[1]||(t[1]=m=>e.$emit("close"))})]),g(h,{style:{"z-index":"2000"},duration:300})])}var fe=y(re,[["render",_e]]);const ve={props:{type:String,src:String},components:{LetterContent:fe,LetterCover:E},data(){return{openTip:"",title:"",paragraphs:[],speed:120,status:"cover"}},mounted(){setTimeout(()=>{this.status="opening",setTimeout(()=>{this.status="opened"},2500)},1e3)},created(){$.getJSON(this.src,({openTip:e,title:t,paragraphs:s,speed:o})=>{this.openTip=e,this.paragraphs=s,this.title=t,this.speed=o})}},ye={class:"letter-cover-wapper"},Te={key:0,class:"letter-cover-wapper",style:{position:"relative","z-index":"2200"}};function $e(e,t,s,o,n,i){const r=d("LetterCover"),p=d("LetterContent");return c(),u(T,null,[l("div",ye,[g(r,{flap:n.status==="opening",openTip:n.openTip},null,8,["flap","openTip"])]),n.status==="opened"?(c(),u("div",Te,[g(p,{onClose:t[0]||(t[0]=h=>e.$emit("close")),title:n.title,paragraphs:n.paragraphs,speed:n.speed},null,8,["title","paragraphs","speed"])])):x("",!0)],64)}var xe=y(ve,[["render",$e]]);const Ce={props:{src:String},mounted(){this.$refs.vlogPlayer.play()}},Me={class:"vlog-cover-wapper"},be={class:"vlog-action"},ke=["src"];function we(e,t,s,o,n,i){const r=d("var-icon");return c(),u("div",Me,[l("div",be,[g(r,{name:"window-close",style:{"font-size":"25px"},onClick:t[0]||(t[0]=p=>e.$emit("close"))})]),l("video",{id:"vlogPlayer",ref:"vlogPlayer",class:"vlog-player",autoplay:"autoplay",playsinline:"true","webkit-playsinline":"true","x-webkit-airplay":"allow",airplay:"allow",loop:"loop","x5-video-player-type":"h5","x5-video-player-fullscreen":"true","x5-video-orientation":"portrait",src:s.src},null,8,ke)])}var Se=y(Ce,[["render",we]]);const Ae={props:{type:String,options:Object},components:{LetterDetail:xe,VlogDetail:Se}};function Oe(e,t,s,o,n,i){const r=d("LetterDetail"),p=d("VlogDetail");return c(),u(T,null,[s.type==="letter"?(c(),v(r,O({key:0},s.options,{onClose:t[0]||(t[0]=h=>e.$emit("close"))}),null,16)):x("",!0),s.type==="vlog"?(c(),v(p,O({key:1},s.options,{onClose:t[1]||(t[1]=h=>e.$emit("close"))}),null,16)):x("",!0)],64)}var Ie=y(Ae,[["render",Oe]]);var Pe="/assets/author.eca664d2.jpg",De="/assets/me.5ec184f2.jpg";const I={AUTHOR:"author",ME:"me"},w={USER_INPUT:"userInput",COMPONENT_CLOSE:"componentClose"},Le={components:{letter:E,vlog:ie,MessageDetail:Ie},props:{title:String,options:Array},computed:{sendBtnDisabled(){return this.status==="systemInput"?!0:!(this.inputMessage&&this.inputMessage.trim().length>0)}},data(){return{messages:[],msgChain:Promise.resolve(),inputMessage:"",nextActionTrigger:null,status:"systemInput",currentOpenComponent:null,isTyping:!1,latestMsgContent:null,authorImg:"",meImg:""}},watch:{options(){this.buildMsgChain(this.options)},status(e,t){e===w.USER_INPUT&&this.setUserInputFoucus()}},methods:{buildMsgChain(e){e.forEach(({msgs:t,msgInputSpeed:s,author:o,triggerNextAction:n})=>{this.msgChain=this.msgChain.then(()=>this.sendSysMsg(t,s,o,n))})},sendSysMsg(e,t=150,s,o=null){return new Promise(n=>{this.sendSysMsgInner(e,t,s).then(()=>{if(o){const i=()=>S(500).then(()=>n());this.nextActionTrigger={inputSpeed:t,triggerNextAction:o,trigger:i},console.log("set trigger",this.nextActionTrigger);const{type:r,options:p}=o;this.status=r}else n()})})},sendSysMsgInner(e,t,s){return new Promise(o=>{const n=Array.isArray(e)?e[e.length-1]:e,i=this.getMsgType(n);if(this.status="systemInput",i==="text"){let r=[""];Array.isArray(e)?r=r.concat(e):r.push(e);const p=new D(".system-input-element",{strings:r,typeSpeed:t,backSpeed:t,onComplete:()=>{p.destroy(),this.pushMsg(n,s||I.AUTHOR,i),S(500).then(()=>o())}})}else this.pushMsg(n,I.AUTHOR,i),S(500).then(()=>o())})},sendUserMsg(){const e=this.inputMessage;if(this.inputMessage="",this.pushMsg(e,I.ME,"text"),!this.nextActionTrigger)return;const{triggerNextAction:t,inputSpeed:s,tryCnt:o=0}=this.nextActionTrigger,{type:n,options:i}=t,{resolveKeyTexts:r,rejectKeyTexts:p,rejectHitTexts:h}=i;if(n===w.USER_INPUT)if(this.rejectNextMsg(e,r,p)){const m=o>=h.length-1,_=h[Math.min(o,h.length-1)];let a=Promise.resolve();Array.isArray(_)?_.forEach(f=>{a=a.then(()=>this.sendSysMsg(f,s))}):a=this.sendSysMsg(_,s),a.then(()=>{m?this.handleTriggerNextAction():this.status=w.USER_INPUT}),this.nextActionTrigger.tryCnt=o+1}else this.handleTriggerNextAction()},handleComponentOpen({type:e,props:t}){this.currentOpenComponent={type:e,props:t}},handleComponentClose(){if(this.currentOpenComponent=null,!this.nextActionTrigger)return;const e=this.nextActionTrigger,{triggerNextAction:t}=e,{type:s,options:o}=t;s===w.COMPONENT_CLOSE&&this.handleTriggerNextAction()},handleTriggerNextAction(){if(!this.nextActionTrigger)return;const e=this.nextActionTrigger,{trigger:t}=e;t(),this.nextActionTrigger=null,console.log("remove trigger",this.nextActionTrigger)},setUserInputFoucus(){const e=()=>{try{!!navigator.userAgent.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/)&&this.$refs.userMsgInputRef.scrollIntoView(!0)}catch{}};setTimeout(()=>{this.$nextTick(()=>{e(),this.$refs.userMsgInputRef.focus()})},1e3)},rejectNextMsg(e,t=[],s=[]){return s.some(o=>e.indexOf(o)>-1)?!0:!t.some(o=>e.indexOf(o)>-1)},pushMsg(e,t,s="text"){this.messages.push({author:t,content:e,type:s,props:this.getProps(e,s)}),Ne()},getProps(e,t){const s={};if(t==="text")return s;const i=new DOMParser().parseFromString(e,"text/html").getElementsByTagName(t);if(i.length===1){const r=i[0];r.getAttributeNames().forEach(h=>s[h]=r.getAttribute(h))}return s},getMsgType(e){const t=/<img[^>]+>/.test(e),s=/<letter[^>]+>/.test(e),o=/<vlog[^>]+>/.test(e);return t?"img":s?"letter":o?"vlog":"text"},markMsgSize(e,t=null){return this.latestMsgContent=t||e.content,S(0).then(()=>e.type==="img"&&j($("#mock-msg img"))).then(()=>{Object.assign(e,Ee()),this.messages=[...this.messages]})}}};function Ne(){setTimeout(()=>{U();const e=$("#mobile-body-content .msg-row:last-child .msg");e.find("a").attr("target","_blank"),j(e).then(U)})}function U(){const e=$("#mobile-body-content"),t=e[0].scrollHeight-e.height()-e.scrollTop(),s=250,o=Date.now();requestAnimationFrame(function n(){const i=Math.min(1,(Date.now()-o)/s);e.scrollTop(e.scrollTop()+t*i),i<1&&requestAnimationFrame(n)})}function S(e=0){return new Promise(t=>{setTimeout(t,e)})}function Ee(){const e=$("#mock-msg");return{width:e.width(),height:e.height()}}function j(e){return new Promise(t=>{e.one("load",t).each((s,o)=>{o.complete&&$(o).trigger("load")})})}const Ue={id:"mobile"},je={id:"mobile-head"},He=l("i",null,null,-1),Ve={id:"mobile-head-title"},Re=l("i",null,null,-1),Be={id:"mobile-body"},Fe=l("div",{id:"mobile-body-bg"},null,-1),ze={id:"mobile-body-content"},qe={id:"mock-msg-row",class:"msg-row"},Ke=["innerHTML"],Ge={key:0,class:"userImg",src:Pe},Je={key:1,class:"userImg",src:De},Xe=["onClick"],Ye=["innerHTML"],Qe={id:"mobile-foot"},We={id:"input-hint",class:"say-something"},Ze={style:{background:"white",width:"100%",height:"32px","line-height":"32px"}},et={style:{color:"black"},class:"system-input-element"},tt=R("\u53D1\u9001");function nt(e,t,s,o,n,i){const r=d("var-input"),p=d("var-col"),h=d("var-button"),m=d("var-row"),_=d("MessageDetail");return c(),u(T,null,[l("div",Ue,[l("div",je,[He,l("div",Ve,P(s.title),1),Re]),l("div",Be,[Fe,l("div",ze,[l("div",qe,[l("div",{id:"mock-msg",class:"msg",innerHTML:n.latestMsgContent},null,8,Ke)]),(c(!0),u(T,null,L(n.messages,(a,f)=>(c(),u("div",{class:A(["msg-row",a.author==="author"?"msg-author":"msg-me"]),key:f},[a.author==="author"?(c(),u("img",Ge)):(c(),u("img",Je)),l("div",{class:A(["msg",{"msg-bounce-in-left":a.author==="author","msg-bounce-in-right":a.author==="me",animate_breathe:f===n.messages.length-1&&n.status==="componentClose"}]),style:H(a.width&&a.height&&{width:a.width-26+"px",height:a.height-18+"px"}),onClick:C=>e.$emit("msg-click",a)},[a.type==="text"?(c(),u("span",{key:0,innerHTML:a.content},null,8,Ye)):(c(),v(V(a.type),O({key:1},a.props,{onOpen:C=>i.handleComponentOpen(a),onClose:i.handleComponentClose}),null,16,["onOpen","onClose"]))],14,Xe)],2))),128))])]),l("div",Qe,[g(m,{gutter:10,justify:"center",align:"center",style:{height:"100%"}},{default:k(()=>[g(p,{span:20},{default:k(()=>[l("div",We,[l("div",Ze,[M(l("span",et,null,512),[[b,n.status==="systemInput"]]),M(g(r,{ref:"userMsgInputRef",class:"animate_breathe",hint:!1,line:!1,modelValue:n.inputMessage,"onUpdate:modelValue":t[0]||(t[0]=a=>n.inputMessage=a)},null,8,["modelValue"]),[[b,n.status==="userInput"]])])])]),_:1}),g(p,{span:4,style:{padding:"0"}},{default:k(()=>[g(h,{ref:"sendMsgBtnRef",color:i.sendBtnDisabled?"#E0E0E0":"#007AFE","text-color":i.sendBtnDisabled?"#aaa":"#fff",disabled:i.sendBtnDisabled,onClick:i.sendUserMsg},{default:k(()=>[tt]),_:1},8,["color","text-color","disabled","onClick"])]),_:1})]),_:1})])]),n.currentOpenComponent?(c(),v(_,{key:0,type:n.currentOpenComponent.type,options:n.currentOpenComponent.props,onClose:i.handleComponentClose},null,8,["type","options","onClose"])):x("",!0)],64)}var st=y(Le,[["render",nt]]);const ot={props:{src:String,title:String},setup(e){const t=e,s=B();F(()=>{$.getJSON(t.src,n=>{s.value=n})});function o({author:n,content:i,type:r}){console.log(n,i,r)}return(n,i)=>(c(),v(st,{options:s.value,title:t.title,onMsgClick:o},null,8,["options","title"]))}},it={setup(e){document.title="\u7231\u4F60\u7684\u5C48\u4E1C\u5947";const t="options/production/chat.json",s="\u5C48\u4E1C\u5947";return(o,n)=>(c(),v(ot,{src:N(t),title:N(s)},null,8,["src","title"]))}};z(it).use(q).mount("#app");
